{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">
{% endblock extra_css %}
{% block content %}
  <div class="container py-4 py-lg-5">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-4">
      <div>
        <h1 class="mb-1">Checkout</h1>
        <p class="text-muted mb-0">Almost there âœ¨ Review your order and add your delivery details.</p>
      </div>
      <a href="{% url 'cart:view' %}" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-2"></i>Back to cart
      </a>
    </div>
    <div class="row g-4">
      <!-- LEFT: Details form -->
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm border-0">
          <div class="card-body p-3 p-md-4">
            <h5 class="mb-1">Delivery details</h5>
            <p class="text-muted mb-3">Where should we send your goodies?</p>
            <form method="post" action="{% url 'checkout:start_checkout' %}" novalidate>
              {% csrf_token %}
              {{ form.non_field_errors }}
              <div class="row g-3">
                {% if user.is_authenticated and form.saved_address %}
                  <div class="col-12">
                    <label class="form-label">Saved address</label>
                    {{ form.saved_address }}
                    <div class="form-text">Pick one to use it, or type a new address below.</div>
                  </div>

                  <script id="saved-addresses-data" type="application/json">
                    {
                      {% for a in user.shipping_addresses.all %}
                        "{{ a.pk }}": {
                          "full_name": "{{ a.full_name|default_if_none:''|escapejs }}",
                          "address_line1": "{{ a.address_line1|escapejs }}",
                          "address_line2": "{{ a.address_line2|default_if_none:''|escapejs }}",
                          "city": "{{ a.city|escapejs }}",
                          "postcode": "{{ a.postcode|escapejs }}"
                        }{% if not forloop.last %},{% endif %}
                      {% endfor %}
                    }
                  </script>
                {% endif %}

                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                    <div class="form-floating flex-grow-1">
                      {{ form.full_name }}
                      <label>Full name</label>
                    </div>
                  </div>
                  {% for error in form.full_name.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                    <div class="form-floating flex-grow-1">
                      {{ form.email }}
                      <label>Email address</label>
                    </div>
                  </div>
                  {% for error in form.email.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                  <div class="form-text">Receipt + dispatch updates go here.</div>
                </div>
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-house"></i></span>
                    <div class="form-floating flex-grow-1">
                      {{ form.address_line1 }}
                      <label>Address line 1</label>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                    <div class="form-floating flex-grow-1">
                      {{ form.address_line2 }}
                      <label>Address line 2 (optional)</label>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-7">
                  <div class="form-floating">
                    {{ form.city }}
                    <label>City</label>
                  </div>
                </div>
                <div class="col-12 col-md-5">
                  <div class="form-floating">
                    {{ form.postcode }}
                    <label>Postcode</label>
                  </div>
                </div>
              </div>
              <hr class="my-4">
              {% if user.is_authenticated and form.save_address %}
                <div class="form-check mb-3">
                  {{ form.save_address }}
                  <label class="form-check-label" for="{{ form.save_address.id_for_label }}">Save this address for next time</label>
                </div>
              {% endif %}
              <button type="submit" class="btn btn-primary w-100 btn-lg">Continue to payment</button>
              <p class="text-muted small mt-3 mb-0 text-center">Payments are processed securely by Stripe.</p>
            </form>
          </div>
        </div>
      </div>
      <!-- RIGHT: Order summary -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm border-0 position-lg-sticky" style="top: 96px;">
          <div class="card-body p-3 p-md-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="mb-0">Order summary</h5>
              <span class="badge text-bg-light">{{ cart.items.count }} item{{ cart.items.count|pluralize }}</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="text-muted small">
                  <tr>
                    <th>Product</th>
                    <th class="text-center" style="width: 72px;">Qty</th>
                    <th class="text-end" style="width: 90px;">Unit</th>
                    <th class="text-end" style="width: 100px;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in cart.items.all %}
                    <tr>
                      <td class="fw-medium">{{ item.product.title }}</td>
                      <td class="text-center">{{ item.qty }}</td>
                      <td class="text-end">Â£{{ item.product.price|floatformat:2 }}</td>
                      <td class="text-end fw-semibold">Â£{{ item.subtotal|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <hr class="my-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-muted">Total</span>
              <span class="h5 mb-0">Â£{{ cart.total|floatformat:2 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block scripts %}
{% endblock scripts %}
{% block extra_js %}
<script>
(function () {
  const select = document.getElementById("id_saved_address");
  if (!select) return;

  const dataEl = document.getElementById("saved-addresses-data");
  if (!dataEl) return;

  let map = {};
  try { map = JSON.parse(dataEl.textContent || "{}"); }
  catch (e) { console.warn("Bad saved address JSON", e); return; }

  const f = {
    full_name: document.getElementById("id_full_name"),
    address_line1: document.getElementById("id_address_line1"),
    address_line2: document.getElementById("id_address_line2"),
    city: document.getElementById("id_city"),
    postcode: document.getElementById("id_postcode"),
  };

  function nudgeFloating(input) {
    if (!input) return;
    input.dispatchEvent(new Event("input", { bubbles: true }));
    input.dispatchEvent(new Event("change", { bubbles: true }));
  }

  function apply(pk) {
    const a = map[String(pk)];
    if (!a) return;

    if (f.full_name) f.full_name.value = a.full_name || "";
    if (f.address_line1) f.address_line1.value = a.address_line1 || "";
    if (f.address_line2) f.address_line2.value = a.address_line2 || "";
    if (f.city) f.city.value = a.city || "";
    if (f.postcode) f.postcode.value = a.postcode || "";

    // ðŸ‘‡ THIS IS WHERE IT GOES
    const saveCb = document.getElementById("id_save_address");
    if (saveCb) saveCb.checked = false;

    Object.values(f).forEach(nudgeFloating);
  }

  select.addEventListener("change", () => {
    if (!select.value) return;
    apply(select.value);
  });

  if (select.value) apply(select.value);
})();
</script>


{% endblock extra_js %}
