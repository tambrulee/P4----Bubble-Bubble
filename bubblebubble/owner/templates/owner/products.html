{% extends "owner/base_owner.html" %}
{% block content %}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
  <div>
    <h1 class="h3 mb-0">Products</h1>
    <div class="text-muted small">Manage listings, stock and images</div>
  </div>

  <div class="d-flex gap-2">
    <a href="{% url 'owner:owner_product_create' %}" class="btn btn-sm btn-dark">
      + Add product
    </a>
    <a href="{% url 'owner:owner_dashboard' %}" class="btn btn-sm btn-outline-secondary">
      ← Back to dashboard
    </a>
  </div>
</div>

<!-- Filter form -->
<form method="get" class="card shadow-sm border-0 p-3 mb-3">
  <div class="row g-2 align-items-end">

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted mb-1">Status</label>
      <select name="status" class="form-select form-select-sm">
        <option value="" {% if not active_status %}selected{% endif %}>All</option>
        <option value="active" {% if active_status == "active" %}selected{% endif %}>Active</option>
        <option value="hidden" {% if active_status == "hidden" %}selected{% endif %}>Hidden</option>
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted mb-1">Tag</label>
      <select name="tag" class="form-select form-select-sm">
        <option value="" {% if not active_tag %}selected{% endif %}>All tags</option>
        {% for t in tag_options %}
          <option value="{{ t }}" {% if active_tag == t %}selected{% endif %}>{{ t|capfirst }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted mb-1">Stock</label>
      <select name="stock" class="form-select form-select-sm">
        <option value="" {% if not active_stock %}selected{% endif %}>All</option>
        <option value="in" {% if active_stock == "in" %}selected{% endif %}>In stock</option>
        <option value="low" {% if active_stock == "low" %}selected{% endif %}>Low stock</option>
        <option value="out" {% if active_stock == "out" %}selected{% endif %}>Out of stock</option>
      </select>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label small text-muted mb-1">Sort</label>
      <select name="sort" class="form-select form-select-sm">
        <option value="title" {% if active_sort == "title" %}selected{% endif %}>Title (A–Z)</option>
        <option value="newest" {% if active_sort == "newest" %}selected{% endif %}>Newest</option>
        <option value="price_asc" {% if active_sort == "price_asc" %}selected{% endif %}>Price: low → high</option>
        <option value="price_desc" {% if active_sort == "price_desc" %}selected{% endif %}>Price: high → low</option>
        <option value="stock_asc" {% if active_sort == "stock_asc" %}selected{% endif %}>Stock: low → high</option>
        <option value="stock_desc" {% if active_sort == "stock_desc" %}selected{% endif %}>Stock: high → low</option>
      </select>
    </div>

    <div class="col-12 d-flex gap-2 mt-2">
      <button class="btn btn-primary btn-sm" type="submit">Apply</button>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'owner:owner_products' %}">Clear</a>
    </div>

  </div>
</form>

<!-- Product list + bulk actions -->
<form method="post" action="{% url 'owner:owner_products_bulk' %}" id="bulkForm">
  {% csrf_token %}

  <div class="card shadow-sm">

    <!-- Bulk action bar -->
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center p-3 border-bottom">
      <div class="d-flex flex-wrap align-items-center gap-2">

        <span class="badge text-bg-light border" id="selectedCount">0 selected</span>

        <!-- Single-select actions -->
        <a href="#"
           class="btn btn-sm btn-outline-secondary disabled"
           id="bulkEditBtn"
           aria-disabled="true">
          Edit
        </a>

        <a href="#"
           class="btn btn-sm btn-outline-secondary disabled"
           id="bulkDuplicateBtn"
           aria-disabled="true">
          Duplicate
        </a>

        <span class="vr mx-2 d-none d-md-inline-block"></span>

        <!-- Multi-select actions -->
        <button type="submit"
                name="action"
                value="activate"
                class="btn btn-sm btn-mm-outline"
                disabled
                data-bulk-multi>
          Activate
        </button>

        <button type="submit"
                name="action"
                value="hide"
                class="btn btn-sm btn-outline-secondary"
                disabled
                data-bulk-multi>
          Hide
        </button>

        <button type="button"
                class="btn btn-sm btn-outline-danger"
                disabled
                data-bulk-multi
                data-bs-toggle="modal"
                data-bs-target="#bulkDeleteModal">
          Delete
        </button>

      </div>

      <div class="small text-muted">
        Select products to edit or bulk update
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:44px;">
              <input class="form-check-input" type="checkbox" id="selectAll" aria-label="Select all">
            </th>
            <th>Title</th>
            <th class="d-none d-md-table-cell"></th>
            <th>Price</th>
            <th>Stock</th>
            <th class="d-none d-md-table-cell">Images</th>
            <th>Status</th>
          </tr>
        </thead>

        <tbody>
          {% for p in products %}
            <tr>
              <td>
                <input class="form-check-input product-check"
                      type="checkbox"
                      name="product_ids"
                      value="{{ p.pk }}"
                      data-edit-url="{% url 'owner:owner_product_edit' p.pk %}"
                      data-dup-url="{% url 'owner:owner_product_duplicate' p.pk %}"
                      aria-label="Select {{ p.title }}">
              </td>

              <td>
                <a href="{% url 'owner:owner_product_edit' p.pk %}"
                  class="d-flex align-items-center gap-2 text-decoration-none">

                  {% with img=p.images.first %}
                    {% if img %}
                      <img src="{{ img.image.url }}"
                          alt="{{ p.title }}"
                          class="bb-thumb">
                    {% else %}
                      <div class="bb-thumb bb-thumb--placeholder" aria-hidden="true"></div>
                    {% endif %}
                  {% endwith %}

                  <div class="fw-semibold text-dark">
                    {{ p.title }}
                    {% if p.stock_qty <= LOW_STOCK_THRESHOLD %}
                      <span class="badge text-bg-warning ms-2">Low</span>
                    {% endif %}
                    {% if not p.active %}
                      <span class="badge text-bg-secondary ms-1">Hidden</span>
                    {% endif %}
                  </div>
                </a>
              </td>



              <td class="d-none d-md-table-cell">{{ p.product_type }}</td>

              <td>£{{ p.price }}</td>

              <td>
                <span class="{% if p.stock_qty <= LOW_STOCK_THRESHOLD %}fw-semibold{% endif %}">
                  {{ p.stock_qty }}
                </span>
                <div class="text-muted small">
                  {% if p.stock_qty <= LOW_STOCK_THRESHOLD %}Restock soon{% else %}In range{% endif %}
                </div>
              </td>

              <td class="d-none d-md-table-cell">
                <span class="badge text-bg-light border">{{ p.image_count }}</span>
              </td>

              <td>
                {% if p.active %}
                  <span class="badge text-bg-success">Active</span>
                {% else %}
                  <span class="badge text-bg-secondary">Hidden</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-muted py-4 text-center">
                No products yet — create your first one.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Bulk delete modal -->
  <div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete selected products?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">This will permanently delete the selected products.</p>
          <p class="text-muted small mb-0">This can’t be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" name="action" value="delete" class="btn btn-danger">
            Yes — delete
          </button>
        </div>
      </div>
    </div>
  </div>

</form>

{% endblock %}

{% block extra_js %}
<script>
(function () {
  const selectAll = document.getElementById("selectAll");
  const checks = Array.from(document.querySelectorAll(".product-check"));
  const countEl = document.getElementById("selectedCount");

  const editBtn = document.getElementById("bulkEditBtn");
  const duplicateBtn = document.getElementById("bulkDuplicateBtn");
  const multiBtns = Array.from(document.querySelectorAll("[data-bulk-multi]"));

  function selectedChecks() {
    return checks.filter(c => c.checked);
  }

  function setLink(btn, url, enabled) {
    btn.classList.toggle("disabled", !enabled);
    btn.setAttribute("aria-disabled", enabled ? "false" : "true");
    if (enabled) btn.href = url;
    else btn.removeAttribute("href");
  }

  function updateUI() {
    const selected = selectedChecks();
    const count = selected.length;

    countEl.textContent = `${count} selected`;

    // Multi-select buttons: enable if 1+
    multiBtns.forEach(btn => btn.disabled = count === 0);

    // Single-select links: enable if exactly 1
    const single = count === 1;
    const one = single ? selected[0] : null;

    setLink(editBtn, one?.dataset.editUrl, single);
    setLink(duplicateBtn, one?.dataset.dupUrl, single);

    // Select-all state
    if (selectAll) {
      selectAll.checked = count > 0 && count === checks.length;
      selectAll.indeterminate = count > 0 && count < checks.length;
    }
  }

  if (selectAll) {
    selectAll.addEventListener("change", () => {
      checks.forEach(c => c.checked = selectAll.checked);
      updateUI();
    });
  }

  checks.forEach(c => c.addEventListener("change", updateUI));
  updateUI();
})();
</script>
{% endblock %}

