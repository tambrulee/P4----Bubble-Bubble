{% extends "owner/base_owner.html" %}
{% load tag_extras %}
{% block content %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h3 mb-0">Orders</h1>
    <div class="text-muted small">Track paid orders and fulfilment statuses</div>
  </div>
      <a href="{% url 'owner:owner_dashboard' %}" class="btn btn-sm btn-outline-secondary mb-2">
      ← Back to dashboard
    </a>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if tab == 'new' %}active{% endif %}" href="?tab=new">
      New
      {% if counts.new %}
        <span class="badge text-bg-primary ms-1">{{ counts.new }}</span>
      {% else %}
        <span class="badge text-bg-light border ms-1">0</span>
      {% endif %}
    </a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if tab == 'dispatched' %}active{% endif %}" href="?tab=dispatched">
      Dispatched
      {% if counts.dispatched %}
        <span class="badge text-bg-info ms-1">{{ counts.dispatched }}</span>
      {% else %}
        <span class="badge text-bg-light border ms-1">0</span>
      {% endif %}
    </a>
  </li>

  <li class="nav-item">
    <a class="nav-link {% if tab == 'delivered' %}active{% endif %}" href="?tab=delivered">
      Delivered
      {% if counts.delivered %}
        <span class="badge text-bg-success ms-1">{{ counts.delivered }}</span>
      {% else %}
        <span class="badge text-bg-light border ms-1">0</span>
      {% endif %}
    </a>
  </li>

  <li class="nav-item ms-auto">
    <a class="nav-link {% if tab == 'all' %}active{% endif %}" href="?tab=all">
      All
      <span class="badge text-bg-secondary ms-1">{{ counts.all }}</span>
    </a>
  </li>
</ul>

<!-- Table -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Fulfilment</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for o in orders %}
          <tr>
            <td class="fw-semibold">#{{ o.id }}</td>

            <td>
              {{ o.created_at|date:"d M Y" }}
              <div class="text-muted small">{{ o.created_at|date:"H:i" }}</div>
            </td>

            <td>
              {{ o.full_name|default:o.email|default:"Guest" }}
              {% if o.email %}
                <div class="text-muted small text-truncate" style="max-width: 260px;">{{ o.email }}</div>
              {% endif %}
            </td>

            <td class="fw-semibold">£{{ o.total }}</td>

            <!-- Payment -->
            <td>
              {% if o.status == "PAID" %}
                <span class="badge text-bg-success">Paid</span>
              {% elif o.status == "PENDING" %}
                <span class="badge text-bg-warning">Pending</span>
              {% else %}
                <span class="badge text-bg-danger">Failed</span>
              {% endif %}
            </td>

            <!-- Fulfilment -->
            <td>
              {% if o.fulfilment_status == "NEW" %}
                <span class="badge text-bg-secondary">New</span>
              {% elif o.fulfilment_status == "DISPATCHED" %}
                <span class="badge text-bg-info">Dispatched</span>
              {% elif o.fulfilment_status == "DELIVERED" %}
                <span class="badge text-bg-success">Delivered</span>
              {% elif o.fulfilment_status == "CANCELLED" %}
                <span class="badge text-bg-dark">Cancelled</span>
              {% else %}
                <span class="badge text-bg-light border">—</span>
              {% endif %}
            </td>

            <!-- Actions -->
            <td class="text-end">
              <div class="d-flex flex-wrap justify-content-end align-items-center gap-2">
                <a class="btn btn-sm btn-outline-secondary"
                  href="{% url 'owner:owner_order_detail' o.id %}">
                  View
                </a>

                {% if o.status == "PAID" %}
                  {% if o.fulfilment_status == "NEW" %}
                    <form method="post"
                          action="{% url 'owner:owner_order_set_fulfilment' o.id 'DISPATCHED' %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-mm text-nowrap" type="submit">
                        Mark dispatched
                      </button>
                    </form>
                  {% endif %}

                  {% if o.fulfilment_status != "DELIVERED" and o.fulfilment_status != "CANCELLED" %}
                    <form method="post"
                          action="{% url 'owner:owner_order_set_fulfilment' o.id 'DELIVERED' %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-mm-outline text-nowrap" type="submit">
                        Mark delivered
                      </button>
                    </form>
                  {% endif %}
                {% endif %}
              </div>

              {% if o.status != "PAID" %}
                <div class="text-muted small mt-1">
                  Fulfilment locked (not paid)
                </div>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>

    </table>
    <!-- Pagination -->
    <nav class="mt-3">
      <ul class="pagination justify-content-center mb-0">

        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
              href="?{% querystring request.GET 'page' page_obj.previous_page_number %}">
              Previous
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
              href="?{% querystring request.GET 'page' page_obj.next_page_number %}">
              Next
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}

      </ul>
    </nav>
  </div>
</div>

{% endblock content %}
